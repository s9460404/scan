<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>答案卷掃描</title>
<style>
  body {
    margin: 0; 
    display: flex; 
    flex-direction: column; 
    align-items: center;
    background: #000;
  }
  video, canvas {
    max-width: 100%;
    height: auto;
  }
  #overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 95%;      /* 調大紅框 */
    height: 80%;
    transform: translate(-50%, -50%);
    border: 4px solid red;
    box-sizing: border-box;
    pointer-events: none;
  }
  #controls {
    position: absolute;
    top: 10px;
    z-index: 10;
    background: rgba(255,255,255,0.8);
    padding: 5px;
    border-radius: 8px;
  }
</style>
</head>
<body>
<div id="controls">
  <select id="cameraSelect"></select>
  <button onclick="capture()">拍照</button>
  <input type="file" accept="image/*" onchange="upload(event)">
</div>
<video id="video" autoplay playsinline></video>
<div id="overlay"></div>
<canvas id="canvas" style="display:none;"></canvas>

<script src="https://docs.opencv.org/4.5.2/opencv.js"></script>
<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let cameraSelect = document.getElementById('cameraSelect');
let detected = { value: [] };

navigator.mediaDevices.enumerateDevices().then(devices => {
  devices.filter(d => d.kind === 'videoinput').forEach((d,i)=>{
    let option = document.createElement('option');
    option.value = d.deviceId;
    option.text = d.label || `Camera ${i+1}`;
    cameraSelect.appendChild(option);
  });
});

cameraSelect.onchange = () => startCamera(cameraSelect.value);

function startCamera(deviceId){
  navigator.mediaDevices.getUserMedia({ video: { deviceId: {exact: deviceId} } })
  .then(stream => video.srcObject = stream);
}

// 預設先開第一個相機
cameraSelect.addEventListener('change', () => startCamera(cameraSelect.value));

function capture(){
  let ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // 紅框範圍
  const cropX = canvas.width * (1 - 0.95)/2;
  const cropY = canvas.height * (1 - 0.8)/2;
  const cropW = canvas.width * 0.95;
  const cropH = canvas.height * 0.8;

  const cropped = ctx.getImageData(cropX, cropY, cropW, cropH);
  processImage(cropped);
}

function upload(event){
  let file = event.target.files[0];
  let img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    canvas.getContext('2d').drawImage(img,0,0);
    let data = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height);
    processImage(data);
  }
  img.src = URL.createObjectURL(file);
}

function processImage(imageData){
  let src = cv.matFromImageData(imageData)
  let gray = new cv.Mat()
  let thresh = new cv.Mat()
  cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY)
  cv.threshold(gray, thresh, 0, 255, cv.THRESH_BINARY_INV + cv.THRESH_OTSU)

  const numBlocks = 4
  const questionsPerBlock = 25
  const rowsPerBlock = 26  // 標題+25題
  const colsPerBlock = 5   // 題號+ABCD

  const blockW = Math.floor(thresh.cols / numBlocks)
  const blockH = thresh.rows

  const cellH = Math.floor(blockH / rowsPerBlock) * 0.98
  const cellW = Math.floor(blockW / colsPerBlock) * 0.98

  let result = []

  for (let block = 0; block < numBlocks; block++) {
    const blockX = block * blockW

    for (let i = 1; i < rowsPerBlock; i++) {  // 跳過標題行
      let qIndex = block * questionsPerBlock + i
      let row = { question: qIndex, A:0, B:0, C:0, D:0 }

      for (let j = 1; j <= 4; j++) {  // 跳過題號欄
        const x = Math.floor(blockX + j * cellW)
        const y = Math.floor(i * cellH)

        if (x+cellW <= thresh.cols && y+cellH <= thresh.rows) {
          const cell = thresh.roi(new cv.Rect(x, y, cellW, cellH))
          const whitePixels = cv.countNonZero(cell)
          console.log(`Q${qIndex} [${['A','B','C','D'][j-1]}]: whitePixels=${whitePixels}`)
          row[['A','B','C','D'][j-1]] = whitePixels > 800 ? 1 : 0
          cell.delete()
        } else {
          console.warn(`跳過超出範圍 Q${qIndex} col ${j}`)
          row[['A','B','C','D'][j-1]] = 0
        }
      }
      result.push(row)
    }
  }

  detected.value = result
  console.log(result)
  alert('掃描完成！')
  src.delete(); gray.delete(); thresh.delete()
}
</script>
</body>
</html>
